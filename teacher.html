<!DOCTYPE html>
<html lang="ja">

<head>
    <script>
        const pass = prompt("Baboot! ç®¡ç†ç”»é¢\n\nã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n        // ==========================================
        // 3. ã‚²ãƒ¼ãƒ ãƒ›ã‚¹ãƒˆãƒ»é€²è¡Œå‡¦ç† (Firebase 6æ¡PINåŒ–)
        // ==========================================
        const players = {};
        let activeQuiz = null;
        let currentQIndex = -1;
        let timerInterval = null;
        let remainingTime = 0;
        let currentRoomId = null;
        let roomRef = null;

        function hostQuiz() {
            if (!currentEditingQuizId) {
                return alert("å‡ºé¡Œã™ã‚‹å‰ã«ã€ã¾ãšã€Œèª­è¾¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚");
            }

            const targetId = getCombinedId();
            if (currentEditingQuizId !== targetId) {
                return alert("æ•™ç§‘ãƒ»å­¦å¹´ãƒ»å›ã®é¸æŠãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦ã€Œèª­è¾¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            }

            activeQuiz = {
                id: currentEditingQuizId,
                title: document.getElementById('round-name').value.trim() || 'ç„¡é¡Œã®ã‚¯ã‚¤ã‚º',
                questions: editingQuestions.filter(q => q.text.trim() !== "")
            };

            if (activeQuiz.questions.length === 0) {
                return alert("å•é¡ŒãŒ1å•ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ä½œæˆã—ã¦ã‹ã‚‰ãƒ›ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚");
            }

            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-lobby').classList.remove('hidden');
            const s = document.getElementById('target-subject').value;
            const g = document.getElementById('target-grade').value;
            const r = document.getElementById('target-round').value;
            document.getElementById('current-quiz-title').innerText = `ãƒ—ãƒ¬ã‚¤ä¸­: ${s} ${g}å¹´ ç¬¬${r}å› - ${activeQuiz.title}`;

            Object.keys(players).forEach(k => delete players[k]);
            document.getElementById('player-grid').innerHTML = '';
            document.getElementById('player-count').innerText = 0;
            document.getElementById('btn-start').disabled = true;

            // 6æ¡ã®æ•°å­—PINã‚’ç”Ÿæˆ (100000 ~ 999999)
            const shortPin = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoomId = 'baboot-' + shortPin;

            document.getElementById('display-pin').innerText = "é€šä¿¡é–‹å§‹ä¸­...";
            document.getElementById('display-pin').style.fontSize = "2em";
            document.getElementById('display-pin').style.color = "orange";
            
            // Set up Firebase Room
            roomRef = db.ref('rooms/' + currentRoomId);
            
            // Previous listeners cleanup
            db.ref('rooms').off();

            roomRef.set({
                state: 'LOBBY',
                created: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('display-pin').style.color = "var(--k-purple)";
                document.getElementById('display-pin').style.fontSize = "5em";
                document.getElementById('display-pin').innerText = shortPin;
                
                // Clear the room on disconnect as cleanup
                roomRef.onDisconnect().remove();

                // Listen for joining students
                roomRef.child('students').on('child_added', (snap) => {
                    const studentId = snap.key;
                    const data = snap.val();
                    if (!players[studentId]) {
                        players[studentId] = { studentId: studentId, name: data.name, score: 0, streak: 0, hasAnsweredThisRound: false };
                        const tag = document.createElement('div'); 
                        tag.className = 'player-tag'; 
                        tag.innerText = data.name;
                        tag.id = "ptag-" + studentId;
                        document.getElementById('player-grid').appendChild(tag);
                        document.getElementById('player-count').innerText = Object.keys(players).length;
                        document.getElementById('btn-start').disabled = false;
                    }
                });
                
                roomRef.child('students').on('child_removed', (snap) => {
                    const studentId = snap.key;
                    if (players[studentId]) {
                        delete players[studentId];
                        const tag = document.getElementById("ptag-" + studentId);
                        if(tag) tag.remove();
                        document.getElementById('player-count').innerText = Object.keys(players).length;
                        if(Object.keys(players).length === 0) document.getElementById('btn-start').disabled = true;
                    }
                });

                // Listen for answers
                roomRef.child('answers').on('child_added', (snap) => {
                    const studentId = snap.key;
                    const data = snap.val();
                    const p = players[studentId];
                    if (!p || p.hasAnsweredThisRound) return;
                    p.hasAnsweredThisRound = true;

                    const currentQ = activeQuiz.questions[currentQIndex];
                    if(!currentQ) return;
                    
                    const isCorrect = (data.choice === currentQ.correctIndex);
                    let points = 0; let bonus = 0;

                    if (isCorrect) {
                        points = Math.max(500, Math.round(1000 - (data.timeTaken * 30)));
                        p.streak++;
                        if (p.streak >= 2) bonus = Math.min(500, (p.streak - 1) * 100);
                        p.score += (points + bonus);
                    } else { p.streak = 0; }

                    p.lastResult = { isCorrect: isCorrect, points: points, bonus: bonus };
                    checkAllAnswered();
                });

            }).catch(e => {
                document.getElementById('display-pin').innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
            });
        }

        function backToDashboard() {
            ['view-lobby', 'view-question', 'view-interim', 'view-result'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('view-editor').classList.remove('hidden');
            clearInterval(timerInterval);
            
            if (roomRef) {
                broadcast({ type: "END" });
                // Room cleanup
                roomRef.remove().then(() => {
                    roomRef = null;
                });
            }
        }

        function broadcast(dataObj) {
            if (!roomRef) return;
            // Write to the broadcast node to update all clients
            roomRef.child('broadcast').set({
                ...dataObj,
                _timestamp: firebase.database.ServerValue.TIMESTAMP // ensure it refreshes on client
            });
        }

        function startGame() {
            document.getElementById('view-lobby').classList.add('hidden');
            currentQIndex = -1; nextQuestion();
        }

        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex >= activeQuiz.questions.length) { showFinalResult(); return; }

            const q = activeQuiz.questions[currentQIndex];
            document.getElementById('view-interim').classList.add('hidden');
            document.getElementById('view-question').classList.remove('hidden');
            document.getElementById('q-num').innerText = currentQIndex + 1;
            
            let qTextHtml = `<div>${q.text}</div>`;
            if (q.text_en || q.text_zh) {
                qTextHtml += `<div style="font-size:0.6em; margin-top:10px; font-weight:normal; color:#555;">`;
                if (q.text_en) qTextHtml += `<span style="margin-right:20px;">ğŸ‡ºğŸ‡¸ ${q.text_en}</span>`;
                if (q.text_zh) qTextHtml += `<span>ğŸ‡¨ğŸ‡³ ${q.text_zh}</span>`;
                qTextHtml += `</div>`;
            }
            document.getElementById('q-text').innerHTML = qTextHtml;

            const colors = ['bg-red', 'bg-blue', 'bg-yellow', 'bg-green'];
            const shapes = ['â–²', 'â—†', 'â—', 'â– '];
            document.getElementById('options-area').innerHTML = q.options.map((opt, i) => {
                let optHtml = `<div style="font-size:1em;">${opt || '(ãªã—)'}</div>`;
                if ((q.options_en && q.options_en[i]) || (q.options_zh && q.options_zh[i])) {
                    optHtml += `<div style="font-size:0.65em; margin-top:8px; font-weight:normal; line-height:1.2; opacity:0.9;">`;
                    if (q.options_en && q.options_en[i]) optHtml += `<div style="margin-bottom:2px;">ğŸ‡ºğŸ‡¸ ${q.options_en[i]}</div>`;
                    if (q.options_zh && q.options_zh[i]) optHtml += `<div>ğŸ‡¨ğŸ‡³ ${q.options_zh[i]}</div>`;
                    optHtml += `</div>`;
                }
                return `<div class="option-card ${colors[i]}" style="display:flex; align-items:center; text-align:left;">
                    <span class="shape-icon">${shapes[i]}</span>
                    <div style="flex:1;">${optHtml}</div>
                </div>`;
            }).join('');

            document.getElementById('q-timer').innerText = q.time;
            document.getElementById('pre-read-overlay').classList.remove('hidden');
            document.getElementById('options-area').classList.add('hidden'); 

            let preTime = 7;
            document.getElementById('pre-timer').innerText = preTime;

            Object.values(players).forEach(p => p.hasAnsweredThisRound = false);
            
            // Clear previous answers
            if(roomRef) roomRef.child('answers').remove();
            if(roomRef) roomRef.child('results').remove();

            broadcast({
                type: "PRE_QUESTION",
                qNum: currentQIndex + 1,
                time: q.time,
                qText: q.text,
                qText_en: q.text_en,
                qText_zh: q.text_zh,
                qOptions: q.options,
                qOptions_en: q.options_en,
                qOptions_zh: q.options_zh,
                preTime: preTime
            });

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                preTime--;
                document.getElementById('pre-timer').innerText = preTime;

                if (preTime <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('pre-read-overlay').classList.add('hidden');
                    document.getElementById('options-area').classList.remove('hidden'); 

                    broadcast({ type: "QUESTION_START" });

                    remainingTime = q.time;
                    document.getElementById('q-timer').innerText = remainingTime;
                    timerInterval = setInterval(() => {
                        remainingTime--;
                        document.getElementById('q-timer').innerText = remainingTime;
                        if (remainingTime <= 0) { clearInterval(timerInterval); finishQuestionPhase(); }
                    }, 1000);
                }
            }, 1000);
        }

        function checkAllAnswered() {
            if (Object.values(players).every(p => p.hasAnsweredThisRound)) {
                clearInterval(timerInterval); setTimeout(finishQuestionPhase, 1000);
            }
        }

        function finishQuestionPhase() {
            document.getElementById('view-question').classList.add('hidden');
            document.getElementById('view-reveal').classList.remove('hidden');

            const q = activeQuiz.questions[currentQIndex];
            const correctIndex = parseInt(q.correctIndex); 
            const colors = ['bg-red', 'bg-blue', 'bg-yellow', 'bg-green'];
            const shapes = ['â–²', 'â—†', 'â—', 'â– '];

            const revealBox = document.getElementById('reveal-correct-box');
            revealBox.className = colors[correctIndex];
            revealBox.innerHTML = `<span style="font-size:1.5em; margin-right:15px;">${shapes[correctIndex]}</span> ${q.options[correctIndex] || '(ãªã—)'}`;

            // Publish results to Firebase
            const resultsData = {};
            Object.values(players).forEach(p => {
                if (!p.hasAnsweredThisRound) {
                    p.streak = 0;
                    resultsData[p.studentId] = { type: "RESULT", isCorrect: false, points: 0, bonus: 0 };
                } else if (p.lastResult) {
                    resultsData[p.studentId] = { type: "RESULT", isCorrect: p.lastResult.isCorrect, points: p.lastResult.points, bonus: p.lastResult.bonus };
                }
            });
            if(roomRef) roomRef.child('results').set(resultsData);
        }

        function showInterimRanking() {
            document.getElementById('view-reveal').classList.add('hidden');
            document.getElementById('view-interim').classList.remove('hidden');

            const sorted = Object.values(players).sort((a, b) => b.score - a.score);

            const top5Data = sorted.slice(0, 5).map(p => ({ name: p.name, score: p.score, streak: p.streak }));
            broadcast({ type: "RANKING", top5: top5Data });

            document.getElementById('interim-table').innerHTML = '<tr><th>é †ä½</th><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>é€£ç¶š<br>æ­£è§£</th></tr>' +
                sorted.slice(0, 5).map((p, i) => `<tr class="ranking-row" style="--i: ${i};"><td>${i + 1}</td><td>${p.name}</td><td>${p.score}</td><td>${p.streak >= 2 ? `ğŸ”¥x${p.streak}` : '-'}</td></tr>`).join('');
        }

        function showFinalResult() {
            clearInterval(timerInterval);
            document.getElementById('view-question').classList.add('hidden');
            document.getElementById('view-interim').classList.add('hidden');
            document.getElementById('view-result').classList.remove('hidden');

            const sorted = Object.values(players).sort((a, b) => b.score - a.score);

            const finalData = sorted.map((p, idx) => ({ rank: idx + 1, name: p.name, score: p.score }));
            broadcast({ type: "FINAL_RANKING", results: finalData });

            [1, 2, 3].forEach(i => {
                document.getElementById(`name-${i}`).innerText = '';
                document.getElementById(`score-${i}`).innerText = '';
                document.getElementById(`bar-${i}`).style.height = '0px';
            });

            if (sorted[0]) { document.getElementById('name-1').innerText = sorted[0].name; document.getElementById('score-1').innerText = sorted[0].score; setTimeout(() => document.getElementById('bar-1').style.height = "250px", 500); }
            if (sorted[1]) { document.getElementById('name-2').innerText = sorted[1].name; document.getElementById('score-2').innerText = sorted[1].score; setTimeout(() => document.getElementById('bar-2').style.height = "180px", 800); }
            if (sorted[2]) { document.getElementById('name-3').innerText = sorted[2].name; document.getElementById('score-3').innerText = sorted[2].score; setTimeout(() => document.getElementById('bar-3').style.height = "120px", 1100); }

            if (sorted.length > 3) {
                let tableHtml = ''; for (let i = 3; i < sorted.length; i++) tableHtml += `<tr><td>${i + 1}ä½</td><td>${sorted[i].name}</td><td>${sorted[i].score}</td></tr>`;
                document.getElementById('final-table').innerHTML = tableHtml;
            }
            broadcast({ type: "END" });
        }

        function downloadCSV() {
            const sorted = Object.values(players).sort((a, b) => b.score - a.score);
            if (sorted.length === 0) {
                alert("å‚åŠ è€…ãŒã„ãªã„ã‹ã€ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            let csvContent = "\uFEFF";
            csvContent += "é †ä½,åå‰,ã‚¹ã‚³ã‚¢\n";

            sorted.forEach((p, index) => {
                let name = p.name ? p.name.replace(/"/g, '""') : 'ä¸æ˜';
                if (name.includes(',') || name.includes('\\n') || name.includes('"')) {
                    name = `"${name}"`;
                }
                csvContent += `${index + 1},${name},${p.score}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const s = document.getElementById('target-subject').value;
            const g = document.getElementById('target-grade').value;
            const r = document.getElementById('target-round').value;
            const title = activeQuiz ? activeQuiz.title : "ç„¡é¡Œ";
            const filename = `Babootæˆç¸¾_${s}_${g}å¹´_ç¬¬${r}å›_${title}.csv`;

            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
\nï¼ˆâ€»æ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å•é¡Œã®ç™»éŒ²ã¯å¾Œã§å„å›ã”ã¨ã«è¡Œã£ã¦ãã ã•ã„ï¼‰`)) {
                closeImportModal();
                localStorage.setItem('baboot_quizzes_local', JSON.stringify(savedQuizzes));

                if (gasUrl) {
                    for (let i = 0; i < newOrUpdatedQuizzes.length; i++) {
                        const q = newOrUpdatedQuizzes[i];
                        showStatus(`GASã¸ä¿å­˜ä¸­... (${i + 1}/${newOrUpdatedQuizzes.length})`, "loading");
                        await syncToGAS('save', q.id, q.subject, q);
                    }
                }

                showStatus("RoundListã®ä¸€æ‹¬ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼", "success");
                loadData(); // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã«åˆã‚ã›ã¦å†æç”»
            }
        }


        // ==========================================



        window.onload = initDashboard;
    </script>
</body>

</html>