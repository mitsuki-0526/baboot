<!DOCTYPE html>
<html lang="ja">

<head>
    <script>
        const pass = prompt("Baboot! ç®¡ç†ç”»é¢\n\nã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(æ—§Babootã®ä¿å­˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨åŒã˜ã§ã™)");
        if (pass !== "baboot") {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç•°ãªã‚‹å ´åˆã¯ã€ãƒ€ãƒŸãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã«ç½®æ›ã—ã¦ä¸­èº«ã‚’è¦‹ã›ãªã„
            document.documentElement.innerHTML = `
                <head><title>Access Denied</title></head>
                <body style="font-family:sans-serif; text-align:center; padding:50px;">
                    <h2 style="color:red;">ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦</h2>
                    <p>ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <a href="index.html">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆç”Ÿå¾’ç”¨ï¼‰ã«æˆ»ã‚‹</a>
                </body>
            `;
            throw new Error("Unauthorized"); // ä»¥é™ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’åœæ­¢
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baboot! - å…ˆç”Ÿç”¨</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --k-purple: #46178f;
            --k-red: #e21b3c;
            --k-blue: #1368ce;
            --k-yellow: #d89e00;
            --k-green: #26890c;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        .top-bar {
            background: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
        }

        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-main {
            background: var(--k-purple);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 1.2em;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 4px 0 #280a59;
            transition: 0.1s;
        }

        .btn-main:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-main:disabled {
            background: #ccc;
            box-shadow: 0 4px 0 #999;
            cursor: not-allowed;
        }

        .btn-next {
            background: var(--k-blue);
            box-shadow: 0 4px 0 #0b458e;
            float: right;
            margin-top: 20px;
        }

        .btn-success {
            background: var(--k-green);
            box-shadow: 0 4px 0 #154d06;
        }

        .btn-danger {
            background: var(--k-red);
            box-shadow: 0 4px 0 #990f26;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 1em;
        }

        /* å…±é€šã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            text-align: center;
        }

        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: #46178f;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select,
        input[type="text"],
        input[type="number"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-weight: bold;
        }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-load {
            background: #333;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-launch {
            background: #d89e00;
            color: #333;
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            box-shadow: 0 2px 0 #916a00;
        }

        .btn-launch:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .btn-danger-round {
            background: #ff4d4d;
            color: white;
            border: 1px solid #cc0000;
            padding: 5px 10px;
            margin-left: 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .btn-danger-round:hover {
            background: #cc0000;
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: #fff;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-content textarea {
            width: 100%;
            height: 200px;
            margin-top: 10px;
            padding: 10px;
            font-family: monospace;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .sidebar {
            width: 280px;
            background: #f0f0f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
        .q-list-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
        }

        .q-list-item:hover {
            background: #e6e6ea;
        }

        .q-list-item.active {
            background: #fff;
            border-left: 5px solid #46178f;
            font-weight: bold;
        }

        .q-num {
            font-size: 0.8em;
            color: #666;
            margin-right: 10px;
        }

        .q-title {
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ•ãƒƒã‚¿ãƒ¼ */
        .sidebar-footer {
            padding: 10px;
            border-top: 1px solid #ccc;
            text-align: center;
            background: #e0e0e5;
        }

        .btn-add-q {
            width: 100%;
            padding: 10px;
            background: #26890c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */
        .editor-main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #fff;
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .editor-main label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #46178f;
        }

        .full-width {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            box-sizing: border-box;
            border-radius: 4px;
        }

        .btn-delete-q {
            background: #e21b3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* é¸æŠè‚¢ã‚°ãƒªãƒƒãƒ‰ */
        .editor-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .gas-settings {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px auto;
            text-align: center;
            border: 2px dashed #ccc;
        }

        .gas-settings input {
            width: 50%;
            padding: 10px;
            font-size: 1em;
            margin-right: 10px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            z-index: 9999;
        }

        /* å¾…æ©Ÿç”»é¢ */
        .pin-display {
            font-size: 5em;
            font-weight: 900;
            letter-spacing: 5px;
            margin: 20px 0;
            background: white;
            display: inline-block;
            padding: 10px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .player-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        .player-tag {
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
            }

            80% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* å‡ºé¡Œç”»é¢ */
        .question-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .timer-circle {
            width: 80px;
            height: 80px;
            background: var(--k-purple);
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5em;
            font-weight: 900;
            margin: 0 auto 20px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .option-card {
            color: white;
            padding: 30px;
            border-radius: 8px;
            font-size: 1.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-align: left;
        }

        .shape-icon {
            font-size: 1.5em;
            margin-right: 20px;
            width: 50px;
            text-align: center;
        }

        /* çµæœç”»é¢ */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 300px;
            gap: 20px;
            margin-top: 50px;
        }

        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            position: relative;
        }

        .podium-bar {
            width: 100%;
            border-radius: 10px 10px 0 0;
            transition: height 1s ease-out;
            height: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
        }

        .podium-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .podium-score {
            font-size: 1.5em;
            font-weight: 900;
            margin-top: 10px;
        }

        .place-1 .podium-bar {
            background: #d89e00;
        }

        .place-2 .podium-bar {
            background: #C0C0C0;
        }

        .place-3 .podium-bar {
            background: #CD7F32;
        }

        .ranking-table {
            max-width: 600px;
            margin: 30px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 1.2em;
        }

        .ranking-table th {
            background: #f0f0f5;
            font-weight: bold;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideUpFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ranking-row {
            animation: slideUpFadeIn 0.5s ease forwards;
            opacity: 0;
            /* åˆæœŸçŠ¶æ…‹ã¯é€æ˜ */
            animation-delay: calc(var(--i) * 0.2s);
            /* é †ç•ªã«è¡¨ç¤º */
        }
    </style>
</head>

<body>

    <div id="loading" class="loading-overlay hidden">
        <div>ğŸš€ é€šä¿¡ä¸­...</div>
    </div>

    <div class="gas-settings">
        <label style="font-weight:bold; color:var(--k-purple);">ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (Apps Script URL)</label>
        <input type="text" id="gas-url-input" placeholder="https://script.google.com/macros/s/.../exec">
        <button class="btn-main" style="padding: 5px 10px; font-size: 1em;" onclick="saveGASUrlAndLoad()">è¨­å®šä¿å­˜</button>
    </div>

    <div id="view-editor" class="container" style="padding: 10px;">
        <div class="header">
            <div class="config-row">
                <select id="target-subject">
                    <option value="å›½èª">å›½èª</option>
                    <option value="æ•°å­¦">æ•°å­¦</option>
                    <option value="ç†ç§‘">ç†ç§‘</option>
                    <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
                    <option value="è‹±èª">è‹±èª</option>
                    <option value="ä¿å¥ä½“è‚²">ä¿å¥ä½“è‚²</option>
                    <option value="ç¾è¡“">ç¾è¡“</option>
                    <option value="å®¶åº­ç§‘">å®¶åº­ç§‘</option>
                    <option value="æŠ€è¡“">æŠ€è¡“</option>
                    <option value="éŸ³æ¥½">éŸ³æ¥½</option>
                </select>
                <select id="target-grade">
                    <option value="1">1å¹´</option>
                    <option value="2">2å¹´</option>
                    <option value="3">3å¹´</option>
                </select>
                <span>ç¬¬</span><input type="number" id="target-round" value="1" min="1"
                    style="width:40px;"><span>å›</span>

                <button class="btn-load" onclick="loadData()">èª­è¾¼</button>
                <button class="btn-launch" onclick="hostQuiz()">â–¶ï¸ ãƒªãƒ¢ãƒ¼ãƒˆå‡ºé¡Œ(ãƒ›ã‚¹ãƒˆ)</button>
                <button class="btn-main"
                    style="background:#0b458e; padding: 8px 15px; font-size:0.9em; box-shadow:none; margin-left:10px;"
                    onclick="exportLocalQuiz()">æ›¸å‡º</button>
            </div>
            <div class="config-row" style="margin-top:10px;">
                <input type="text" id="round-name" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: éŸ³æ¥½å²ã‚¯ã‚¤ã‚º)" style="width:300px;">
                <button class="btn-danger-round" onclick="deleteRound()">å‰Šé™¤</button>
            </div>
            <div class="config-row" style="margin-top:10px;">
                <button class="btn-main btn-success" style="padding: 5px 15px; font-size: 0.9em;"
                    onclick="openImportModal()">â¬‡ï¸ æ—§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar" id="editor-sidebar" style="display:none;">
                <div id="q-list-container" style="flex:1; overflow-y:auto;">
                    <!-- å•é¡Œãƒªã‚¹ãƒˆ -->
                </div>
                <div class="sidebar-footer">
                    <button class="btn-add-q" onclick="addNewQuestionNode()">ï¼‹ å•é¡Œã‚’è¿½åŠ </button>
                </div>
            </div>

            <div class="editor-main" id="editor-main-area" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; color:#46178f;">Question Editor <span id="current-q-num"></span></h3>
                    <button class="btn-delete-q" onclick="deleteCurrentQuestion()">ğŸ—‘ å‰Šé™¤</button>
                </div>

                <div class="form-group">
                    <label>å•é¡Œæ–‡</label>
                    <input type="text" id="inp-text" class="full-width" placeholder="ä¾‹: æ—¥æœ¬ã§ä¸€ç•ªé«˜ã„å±±ã¯ï¼Ÿ"
                        oninput="updateCurrentQuestionData()">
                </div>

                <div class="form-group" style="display:flex; gap: 20px;">
                    <div>
                        <label>åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="inp-time" value="15" min="5"
                            style="padding:10px; width: 80px; font-size:1.1em; border:1px solid #ccc; border-radius:4px;"
                            oninput="updateCurrentQuestionData()"> ç§’
                    </div>
                    <div style="flex:1;">
                        <label>æ­£è§£ã®é¸æŠè‚¢</label>
                        <select id="inp-correct" class="full-width" style="padding:10px;"
                            onchange="updateCurrentQuestionData()">
                            <option value="0">é¸æŠè‚¢ 1 (èµ¤ â–²)</option>
                            <option value="1">é¸æŠè‚¢ 2 (é’ â—†)</option>
                            <option value="2">é¸æŠè‚¢ 3 (é»„ â—)</option>
                            <option value="3">é¸æŠè‚¢ 4 (ç·‘ â– )</option>
                        </select>
                    </div>
                </div>

                <label>é¸æŠè‚¢ã®å†…å®¹</label>
                <div class="editor-options-grid">
                    <div><label style="color:var(--k-red); font-size:0.8em;">é¸æŠè‚¢ 1 (â–²)</label><input type="text"
                            id="inp-opt0" class="full-width" oninput="updateCurrentQuestionData()"></div>
                    <div><label style="color:var(--k-blue); font-size:0.8em;">é¸æŠè‚¢ 2 (â—†)</label><input type="text"
                            id="inp-opt1" class="full-width" oninput="updateCurrentQuestionData()"></div>
                    <div><label style="color:var(--k-yellow); font-size:0.8em;">é¸æŠè‚¢ 3 (â—)</label><input type="text"
                            id="inp-opt2" class="full-width" oninput="updateCurrentQuestionData()"></div>
                    <div><label style="color:var(--k-green); font-size:0.8em;">é¸æŠè‚¢ 4 (â– )</label><input type="text"
                            id="inp-opt3" class="full-width" oninput="updateCurrentQuestionData()"></div>
                </div>
            </div>

            <div id="empty-view"
                style="flex:1; display:flex; justify-content:center; align-items:center; flex-direction:column; color:#ccc;">
                <h2>ğŸ‘ˆ æ•™ç§‘ãƒ»å­¦å¹´ãƒ»å›ã‚’é¸ã‚“ã§ã€Œèª­è¾¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</h2>
            </div>
        </div>

        <div class="toolbar"
            style="padding: 15px 20px; background: #eee; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <div id="status" class="status" style="font-weight:bold;"></div>
            <button class="btn-main btn-success" onclick="saveQuiz()">ä¿å­˜ã™ã‚‹ (Save)</button>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 style="color: var(--k-purple); margin-top: 0;">â¬‡ï¸ æ—§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">
                <strong>æ–¹æ³•1: ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ</strong><br>
                éå»ã®ã€ŒBaboot!ã€ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆAåˆ—ã€œPåˆ—ãªã©ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸‹ã®æ ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                <strong>æ–¹æ³•2: URLã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰</strong><br>
                æ—§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ï¼ã€Œå…±æœ‰ã€ï¼ã€Œã‚¦ã‚§ãƒ–ã«å…¬é–‹ã€ã‹ã‚‰ã€Œ<strong>CSVå½¢å¼</strong>ã€ã‚’é¸ã‚“ã§å…¬é–‹ã—ã€ç™ºè¡Œã•ã‚ŒãŸURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                <br>
                â€» ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ç”»é¢ã§ç·¨é›†ä¸­ã®å•é¡Œã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
            </p>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: var(--k-blue); display:block; margin-bottom:5px;">ğŸŒ
                    ã‚¦ã‚§ãƒ–ã«å…¬é–‹ã•ã‚ŒãŸCSVã®URL (æ–¹æ³•2)</label>
                <input type="text" id="import-url-input"
                    placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"
                    style="width: 100%; box-sizing: border-box;">
            </div>

            <label style="font-weight: bold; color: var(--k-purple);">ğŸ“ ç›´æ¥è²¼ã‚Šä»˜ã‘ (æ–¹æ³•1)</label>
            <textarea id="import-textarea" placeholder="ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡Œã‚’è²¼ã‚Šä»˜ã‘..."></textarea>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn-main" style="background: #ccc; box-shadow: 0 4px 0 #999; color: #333;"
                    onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-main btn-success" style="margin-top: 0; background: #26890c;"
                    onclick="processRoundListImportData()">RoundListã®ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="btn-main btn-next" style="margin-top: 0;"
                    onclick="processImportData()">å•é¡Œãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- ã€1ã€‘å¾…æ©Ÿç”»é¢ -->
    <div id="view-lobby" class="container hidden">
        <h2 style="margin-top: 50px;">é»’æ¿ã«ã“ã®PINï¼ˆ6æ¡ã®æ•°å­—ï¼‰ã‚’æ›¸ã„ã¦ã€å‚åŠ ã‚’å¾…ã¨ã†ï¼</h2>
        <div class="pin-display" id="display-pin">------</div>
        <h3 id="current-quiz-title" style="color:var(--k-purple);"></h3>
        <br>
        <button class="btn-main btn-success" id="btn-start" onclick="startGame()" disabled
            style="font-size: 1.5em; padding: 15px 40px;">å…¨å“¡æƒã£ãŸã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        <button class="btn-main btn-danger" onclick="backToDashboard()"
            style="display:block; margin: 20px auto;">ã‚„ã‚ã‚‹</button>
        <div style="font-size: 1.2em; font-weight: bold; margin-top: 20px;">ç¾åœ¨ã®å‚åŠ äººæ•°: <span id="player-count">0</span> äºº
        </div>
        <div class="player-grid" id="player-grid"></div>
    </div>

    <!-- ã€2ã€‘å‡ºé¡Œç”»é¢ -->
    <div id="view-question" class="container hidden">
        <div style="text-align: left; font-weight: bold; font-size: 1.2em; color: #666; margin-bottom: 10px;">
            Q<span id="q-num">1</span>
            <button class="btn-main btn-danger btn-small" onclick="showFinalResult()"
                style="float:right; font-size: 0.8em; padding: 5px 10px;">â–  é€”ä¸­ã§çµ‚äº†ã™ã‚‹</button>
            <div style="clear:both;"></div>
        </div>

        <div id="pre-read-overlay"
            style="background:#fff3cd; color:#856404; padding:10px; margin-bottom:10px; border-radius:5px; font-weight:bold; font-size:1.2em; border:1px solid #ffeeba;">
            å•é¡Œã‚’èª­ã‚€æ™‚é–“ã§ã™... (<span id="pre-timer">7</span>)
        </div>

        <div class="question-box" id="q-text">å•é¡Œæ–‡ãŒã“ã“ã«å…¥ã‚Šã¾ã™</div>
        <div class="timer-circle" id="q-timer">15</div>
        <div class="options-grid" id="options-area"></div>
    </div>

    <!-- ã€3-Aã€‘æ­£è§£ç™ºè¡¨ç”»é¢ (NEW) -->
    <div id="view-reveal" class="container hidden">
        <h2>æ­£è§£ã¯...</h2>
        <div id="reveal-correct-box"
            style="margin: 30px auto; padding: 30px; border-radius: 12px; color: white; font-size: 2em; font-weight: bold; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
            <!-- æ­£è§£ã®é¸æŠè‚¢ãŒã“ã“ã«å…¥ã‚‹ -->
        </div>
        <button class="btn-main btn-next" onclick="showInterimRanking()" style="margin-top:20px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º ï¼</button>
    </div>

    <!-- ã€3-Bã€‘ä¸­é–“ç™ºè¡¨ç”»é¢ -->
    <div id="view-interim" class="container hidden">
        <h2>ä»Šã®å•é¡Œã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTop 5ï¼‰</h2>
        <table class="ranking-table" id="interim-table"></table>
        <button class="btn-main btn-next" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ ï¼</button>
        <div style="clear:both;"></div>
    </div>

    <!-- ã€4ã€‘æœ€çµ‚çµæœç”»é¢ -->
    <div id="view-result" class="container hidden">
        <h1 style="font-size: 3em; margin-top: 20px;">æœ€çµ‚çµæœç™ºè¡¨ï¼ğŸ†</h1>

        <div class="podium-container">
            <div class="podium-item place-2">
                <div class="podium-name" id="name-2"></div>
                <div class="podium-bar" id="bar-2">
                    <div class="podium-score" id="score-2"></div>
                </div>
            </div>
            <div class="podium-item place-1">
                <div class="podium-name" id="name-1"></div>
                <div class="podium-bar" id="bar-1">
                    <div class="podium-score" id="score-1"></div>
                </div>
            </div>
            <div class="podium-item place-3">
                <div class="podium-name" id="name-3"></div>
                <div class="podium-bar" id="bar-3">
                    <div class="podium-score" id="score-3"></div>
                </div>
            </div>
        </div>

        <table class="ranking-table" id="final-table" style="margin-top: 50px;"></table>
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
            <button class="btn-main btn-success" onclick="downloadCSV()">æˆç¸¾ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰(CSV)</button>
            <button class="btn-main" onclick="backToDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ç®¡ç† (GAS & LocalStorage)
        // ==========================================
        let savedQuizzes = [];
        let currentEditingQuizId = null;
        let gasUrl = localStorage.getItem('baboot_gas_url') || '';

        // ã‚¨ãƒ‡ã‚£ã‚¿ç”¨ãƒ‡ãƒ¼ã‚¿
        let editingQuestions = [];
        let currentSelectedQIndex = -1;

        async function initDashboard() {
            if (gasUrl) {
                document.getElementById('gas-url-input').value = gasUrl;
                await fetchAllFromGAS();
            } else {
                const localData = localStorage.getItem('baboot_quizzes_local');
                if (localData) savedQuizzes = JSON.parse(localData);
                else savedQuizzes = [];
            }
        }

        function saveGASUrlAndLoad() {
            const inputUrl = document.getElementById('gas-url-input').value.trim();
            if (inputUrl !== gasUrl || inputUrl === "") {
                const pass = prompt("URLã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ baboot ã§ã™)");
                if (pass !== "baboot") {
                    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚");
                    return;
                }
            }

            gasUrl = inputUrl;
            localStorage.setItem('baboot_gas_url', gasUrl);
            if (gasUrl) { fetchAllFromGAS(); }
            else {
                alert("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è§£é™¤ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚");
                savedQuizzes = JSON.parse(localStorage.getItem('baboot_quizzes_local') || '[]');
            }
        }

        async function fetchAllFromGAS() {
            showLoading(true);
            try {
                const response = await fetch(gasUrl, { method: 'GET', redirect: 'follow' });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();

                if (Array.isArray(data)) {
                    savedQuizzes = data;
                } else if (data && data.error) {
                    throw new Error(data.error);
                } else {
                    alert("GASã‹ã‚‰æ­£ã—ããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ã€ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãŒã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
            showLoading(false);
        }

        async function syncToGAS(action, quizId, subject = 'ãã®ä»–', quizData = null) {
            if (!gasUrl) {
                localStorage.setItem('baboot_quizzes_local', JSON.stringify(savedQuizzes));
                return true;
            }
            showLoading(true);
            try {
                await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: action, id: quizId, subject: subject, quiz: quizData })
                });
            } catch (e) { console.error(e); }
            showLoading(false);
            return true;
        }

        function showLoading(show) {
            document.getElementById('loading').className = show ? 'loading-overlay' : 'loading-overlay hidden';
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.style.color = type === 'success' ? '#26890c' : '#46178f';
            setTimeout(() => { if (type === 'success') el.innerText = ""; }, 3000);
        }

        // ==========================================
        // 2. æ•™ç§‘/å­¦å¹´/å› ã§èª­ã¿è¾¼ã¿ãƒ»ç®¡ç†
        // ==========================================
        function getCombinedId() {
            const s = document.getElementById('target-subject').value;
            const g = document.getElementById('target-grade').value;
            const r = document.getElementById('target-round').value;
            return `${s}_${g}_${r}`;
        }

        function loadData() {
            const targetId = getCombinedId();
            currentEditingQuizId = targetId;

            const quiz = savedQuizzes.find(q => q.id === targetId);
            if (quiz) {
                document.getElementById('round-name').value = quiz.title || "";
                editingQuestions = JSON.parse(JSON.stringify(quiz.questions || []));
                showStatus("èª­ã¿è¾¼ã¿å®Œäº†", "success");
            } else {
                document.getElementById('round-name').value = "";
                editingQuestions = [];
                showStatus("æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰", "success");
            }

            document.getElementById('empty-view').style.display = 'none';
            document.getElementById('editor-main-area').style.display = 'block';
            document.getElementById('editor-sidebar').style.display = 'flex';

            if (editingQuestions.length === 0) {
                addNewQuestionNode();
            } else {
                renderSidebarList();
                selectQuestion(0);
            }
        }

        function renderSidebarList() {
            const container = document.getElementById('q-list-container');
            container.innerHTML = '';
            editingQuestions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'q-list-item' + (i === currentSelectedQIndex ? ' active' : '');
                div.onclick = () => selectQuestion(i);
                div.innerHTML = `
          <span class="q-num">Q${i + 1}</span>
          <span class="q-title" style="margin-left:10px;">${q.text || '(æœªå…¥åŠ›)'}</span>
        `;
                container.appendChild(div);
            });
        }

        function selectQuestion(index) {
            if (index < 0 || index >= editingQuestions.length) return;
            currentSelectedQIndex = index;
            renderSidebarList();

            const q = editingQuestions[index];
            document.getElementById('current-q-num').innerText = `#${index + 1}`;
            document.getElementById('inp-text').value = q.text || '';
            document.getElementById('inp-time').value = q.time || 15;
            document.getElementById('inp-correct').value = q.correctIndex || 0;

            const opts = q.options || ['', '', '', ''];
            document.getElementById('inp-opt0').value = opts[0] || '';
            document.getElementById('inp-opt1').value = opts[1] || '';
            document.getElementById('inp-opt2').value = opts[2] || '';
            document.getElementById('inp-opt3').value = opts[3] || '';
        }

        function updateCurrentQuestionData() {
            if (currentSelectedQIndex < 0) return;
            const q = editingQuestions[currentSelectedQIndex];
            q.text = document.getElementById('inp-text').value;
            q.time = parseInt(document.getElementById('inp-time').value) || 15;
            q.correctIndex = parseInt(document.getElementById('inp-correct').value) || 0;
            q.options = [
                document.getElementById('inp-opt0').value,
                document.getElementById('inp-opt1').value,
                document.getElementById('inp-opt2').value,
                document.getElementById('inp-opt3').value
            ];
            renderSidebarList();
        }

        function addNewQuestionNode() {
            editingQuestions.push({ text: '', time: 15, options: ['', '', '', ''], correctIndex: 0 });
            selectQuestion(editingQuestions.length - 1);
        }

        function deleteCurrentQuestion() {
            if (editingQuestions.length <= 1) {
                alert("æœ€ä½1ã¤ã®å•é¡ŒãŒå¿…è¦ã§ã™ï¼"); return;
            }
            if (confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                editingQuestions.splice(currentSelectedQIndex, 1);
                selectQuestion(Math.max(0, currentSelectedQIndex - 1));
            }
        }

        async function saveQuiz() {
            if (!currentEditingQuizId) return alert("å…ˆã«ã€Œèª­è¾¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            const title = document.getElementById('round-name').value.trim() || 'ç„¡é¡Œã®ã‚¯ã‚¤ã‚º';
            const subject = document.getElementById('target-subject').value;

            const validQuestions = editingQuestions.filter(q => q.text.trim() !== "");
            if (validQuestions.length === 0) {
                alert("1ã¤ä»¥ä¸Šã®å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return;
            }

            showStatus("ä¿å­˜ä¸­...", "loading");

            const newQuiz = { id: currentEditingQuizId, subject: subject, title, questions: validQuestions };
            const existingIndex = savedQuizzes.findIndex(q => q.id === currentEditingQuizId);

            if (existingIndex >= 0) { savedQuizzes[existingIndex] = newQuiz; }
            else { savedQuizzes.push(newQuiz); }

            await syncToGAS('save', currentEditingQuizId, subject, newQuiz);
            showStatus("ä¿å­˜ã—ã¾ã—ãŸï¼", "success");
        }

        async function deleteRound() {
            const targetId = getCombinedId();
            const subject = document.getElementById('target-subject').value;
            if (confirm('ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ æ•™ç§‘/å­¦å¹´/å› ã®ã‚¯ã‚¤ã‚ºã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                savedQuizzes = savedQuizzes.filter(q => q.id !== targetId);
                await syncToGAS('delete', targetId, subject);
                alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                document.getElementById('round-name').value = "";
                editingQuestions = [];
                document.getElementById('empty-view').style.display = 'flex';
                document.getElementById('editor-main-area').style.display = 'none';
                document.getElementById('editor-sidebar').style.display = 'none';
                renderSidebarList();
            }
        }

        function exportLocalQuiz() {
            const targetId = getCombinedId();
            const quiz = savedQuizzes.find(q => q.id === targetId);
            if (!quiz) return alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(quiz, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `Baboot_${quiz.id}_${quiz.title}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // ==========================================
        // 2-B. æ—§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        // ==========================================
        function openImportModal() {
            if (!currentEditingQuizId) {
                return alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å‰ã«ã€ã¾ãšè©²å½“ã™ã‚‹ã€Œæ•™ç§‘ãƒ»å­¦å¹´ãƒ»å›ã€ã‚’é¸ã‚“ã§ã€Œèª­è¾¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            }
            document.getElementById('import-textarea').value = '';
            document.getElementById('import-url-input').value = '';
            document.getElementById('import-modal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
        }

        // CSVã®ç°¡æ˜“ãƒ‘ãƒ¼ã‚µãƒ¼ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œ)
        function parseCSVToArray(text) {
            const result = [];
            let row = [];
            let inQuotes = false;
            let val = '';
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                let nextChar = text[i + 1];
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        val += '"'; i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    row.push(val); val = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (char === '\r' && nextChar === '\n') { i++; }
                    row.push(val); result.push(row); row = []; val = '';
                } else {
                    val += char;
                }
            }
            if (val !== '' || row.length > 0) { row.push(val); result.push(row); }
            return result;
        }

        async function processImportData() {
            const rawData = document.getElementById('import-textarea').value;
            const urlInput = document.getElementById('import-url-input').value.trim();

            let rows = [];

            if (urlInput) {
                // URLã‹ã‚‰å–å¾—ã™ã‚‹å ´åˆ
                try {
                    showStatus("ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...", "loading");
                    const res = await fetch(urlInput);
                    if (!res.ok) throw new Error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼");
                    const csvText = await res.text();
                    rows = parseCSVToArray(csvText);
                    showStatus("", "success");
                } catch (e) {
                    alert("URLã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ã‚¦ã‚§ãƒ–ã«å…¬é–‹(CSVå½¢å¼)ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                    showStatus("", "success");
                    return;
                }
            } else if (rawData.trim()) {
                // ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã®å ´åˆ (ã‚¿ãƒ–åŒºåˆ‡ã‚Š)
                const textRows = rawData.split('\n');
                rows = textRows.map(r => r.split('\t'));
            } else {
                alert("URLã‹ãƒ‡ãƒ¼ã‚¿ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const importedQuestions = [];

            for (let i = 0; i < rows.length; i++) {
                const cols = rows[i];
                if (cols.length < 2) continue;

                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¬é–‹CSVã®å ´åˆã€æœ€åˆã®è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                if (i === 0 && cols[0] === 'æ­£è§£ç•ªå·') continue;

                const correctData = cols[0] ? String(cols[0]).trim() : "1";
                const questionText = cols[1] ? String(cols[1]).trim() : "";
                if (!questionText) continue;

                let correctIdx = parseInt(correctData) - 1;
                if (isNaN(correctIdx) || correctIdx < 0 || correctIdx > 3) correctIdx = 0;

                const op1 = cols.length > 4 ? String(cols[4]).trim() : "";
                const op2 = cols.length > 7 ? String(cols[7]).trim() : "";
                const op3 = cols.length > 10 ? String(cols[10]).trim() : "";
                const op4 = cols.length > 13 ? String(cols[13]).trim() : "";

                importedQuestions.push({
                    text: questionText,
                    time: 15,
                    options: [op1, op2, op3, op4],
                    correctIndex: correctIdx
                });
            }

            if (importedQuestions.length === 0) {
                alert("æœ‰åŠ¹ãªå•é¡Œè¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            if (confirm(`${importedQuestions.length}å• èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nç¾åœ¨ã®ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                editingQuestions = importedQuestions;
                renderSidebarList();
                selectQuestion(0);
                closeImportModal();
                showStatus("ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸã€‚ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚", "success");
            }
        }

        async function processRoundListImportData() {
            const rawData = document.getElementById('import-textarea').value;
            const urlInput = document.getElementById('import-url-input').value.trim();

            let rows = [];

            if (urlInput) {
                try {
                    showStatus("ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...", "loading");
                    const res = await fetch(urlInput);
                    if (!res.ok) throw new Error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼");
                    const csvText = await res.text();
                    rows = parseCSVToArray(csvText);
                    showStatus("", "success");
                } catch (e) {
                    alert("URLã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ã‚¦ã‚§ãƒ–ã«å…¬é–‹(CSVå½¢å¼)ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                    showStatus("", "success");
                    return;
                }
            } else if (rawData.trim()) {
                const textRows = rawData.split('\n');
                rows = textRows.map(r => r.split('\t'));
            } else {
                alert("URLã‹ãƒ‡ãƒ¼ã‚¿ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            let importCount = 0;
            const newOrUpdatedQuizzes = [];

            for (let i = 0; i < rows.length; i++) {
                const cols = rows[i];
                if (cols.length < 4) continue;
                if (i === 0 && cols[0] === 'æ•™ç§‘') continue;

                const subject = String(cols[0]).trim();
                const grade = String(cols[1]).trim();
                const round = String(cols[2]).trim();
                const title = String(cols[3]).trim();

                if (!subject || !grade || !round) continue;

                const id = `${subject}_${grade}_${round}`;
                const existingIndex = savedQuizzes.findIndex(q => q.id === id);

                let qObj;
                if (existingIndex >= 0) {
                    savedQuizzes[existingIndex].title = title;
                    qObj = savedQuizzes[existingIndex];
                } else {
                    qObj = { id: id, subject: subject, title: title, questions: [] };
                    savedQuizzes.push(qObj);
                }
                newOrUpdatedQuizzes.push(qObj);
                importCount++;
            }

            if (importCount === 0) {
                alert("æœ‰åŠ¹ãªRoundListè¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            if (confirm(`${importCount}ä»¶ã®ã‚¿ã‚¤ãƒˆãƒ«æ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nGAS(ã‚ªãƒ³ãƒ©ã‚¤ãƒ³)ã«ä¸€æ‹¬ä½œæˆãƒ»ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆâ€»æ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å•é¡Œã®ç™»éŒ²ã¯å¾Œã§å„å›ã”ã¨ã«è¡Œã£ã¦ãã ã•ã„ï¼‰`)) {
                closeImportModal();
                localStorage.setItem('baboot_quizzes_local', JSON.stringify(savedQuizzes));

                if (gasUrl) {
                    for (let i = 0; i < newOrUpdatedQuizzes.length; i++) {
                        const q = newOrUpdatedQuizzes[i];
                        showStatus(`GASã¸ä¿å­˜ä¸­... (${i + 1}/${newOrUpdatedQuizzes.length})`, "loading");
                        await syncToGAS('save', q.id, q.subject, q);
                    }
                }

                showStatus("RoundListã®ä¸€æ‹¬ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼", "success");
                loadData(); // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã«åˆã‚ã›ã¦å†æç”»
            }
        }


        // ==========================================
        // 3. ã‚²ãƒ¼ãƒ ãƒ›ã‚¹ãƒˆãƒ»é€²è¡Œå‡¦ç† (PeerJS 6æ¡PINåŒ–)
        // ==========================================
        let peer = null;
        const players = {};
        let activeQuiz = null;
        let currentQIndex = -1;
        let timerInterval = null;
        let remainingTime = 0;

        function hostQuiz() {
            if (!currentEditingQuizId) {
                return alert("å‡ºé¡Œã™ã‚‹å‰ã«ã€ã¾ãšã€Œèª­è¾¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚");
            }

            const targetId = getCombinedId();
            if (currentEditingQuizId !== targetId) {
                return alert("æ•™ç§‘ãƒ»å­¦å¹´ãƒ»å›ã®é¸æŠãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦ã€Œèª­è¾¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            }

            // ç¾åœ¨ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã«ã‚ã‚‹æœ€æ–°ã®çŠ¶æ…‹ã§ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚ˆã†ã€activeQuizã«åæ˜ 
            activeQuiz = {
                id: currentEditingQuizId,
                title: document.getElementById('round-name').value.trim() || 'ç„¡é¡Œã®ã‚¯ã‚¤ã‚º',
                questions: editingQuestions.filter(q => q.text.trim() !== "")
            };

            if (activeQuiz.questions.length === 0) {
                return alert("å•é¡ŒãŒ1å•ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ä½œæˆã—ã¦ã‹ã‚‰ãƒ›ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚");
            }

            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-lobby').classList.remove('hidden');
            const s = document.getElementById('target-subject').value;
            const g = document.getElementById('target-grade').value;
            const r = document.getElementById('target-round').value;
            document.getElementById('current-quiz-title').innerText = `ãƒ—ãƒ¬ã‚¤ä¸­: ${s} ${g}å¹´ ç¬¬${r}å› - ${activeQuiz.title}`;

            Object.keys(players).forEach(k => delete players[k]);
            document.getElementById('player-grid').innerHTML = '';
            document.getElementById('player-count').innerText = 0;
            document.getElementById('btn-start').disabled = true;

            // 6æ¡ã®æ•°å­—PINã‚’ç”Ÿæˆ (100000 ~ 999999)
            const shortPin = Math.floor(100000 + Math.random() * 900000).toString();
            const peerId = 'baboot-' + shortPin;

            if (peer != null) { peer.destroy(); }

            document.getElementById('display-pin').innerText = "ç”Ÿæˆä¸­...";

            // PeerJSã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š (ã‚¨ãƒ©ãƒ¼æ™‚ã¯Catchã™ã‚‹)
            peer = new Peer(peerId, { debug: 2 });

            peer.on('open', (id) => {
                document.getElementById('display-pin').innerText = shortPin;
                console.log('PeerJS connected with ID:', id);
            });

            peer.on('error', (err) => {
                document.getElementById('display-pin').innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
                document.getElementById('display-pin').style.fontSize = "2em";
                document.getElementById('display-pin').style.color = "red";
                console.error('PeerJS Error:', err);

                if (err.type === 'unavailable-id') {
                    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: PINç•ªå·ãŒè¡çªã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                } else if (err.type === 'network' || err.type === 'server-error') {
                    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: PeerJSã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚");
                } else {
                    alert("PeerJSã‚¨ãƒ©ãƒ¼: " + err.type + "\n" + err.message);
                }
            });

            peer.on('connection', (conn) => {
                conn.on('data', (dataStr) => { try { handleClientData(conn, JSON.parse(dataStr)); } catch (e) { } });
            });
        }

        function backToDashboard() {
            ['view-lobby', 'view-question', 'view-interim', 'view-result'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('view-editor').classList.remove('hidden');
            clearInterval(timerInterval);
            if (peer != null) {
                broadcast({ type: "END" });
                setTimeout(() => { peer.destroy(); peer = null; }, 1000);
            }
        }

        function handleClientData(conn, data) {
            if (data.type === "JOIN") {
                if (!players[conn.peer]) {
                    players[conn.peer] = { conn: conn, name: data.name, score: 0, streak: 0, hasAnsweredThisRound: false };
                    const tag = document.createElement('div'); tag.className = 'player-tag'; tag.innerText = data.name;
                    document.getElementById('player-grid').appendChild(tag);
                    document.getElementById('player-count').innerText = Object.keys(players).length;
                    document.getElementById('btn-start').disabled = false;
                }
            } else if (data.type === "ANSWER") {
                const p = players[conn.peer];
                if (!p || p.hasAnsweredThisRound) return;
                p.hasAnsweredThisRound = true;

                const currentQ = activeQuiz.questions[currentQIndex];
                const isCorrect = (data.choice === currentQ.correctIndex);
                let points = 0; let bonus = 0;

                if (isCorrect) {
                    points = Math.max(500, Math.round(1000 - (data.timeTaken * 30)));
                    p.streak++;
                    if (p.streak >= 2) bonus = Math.min(500, (p.streak - 1) * 100);
                    p.score += (points + bonus);
                } else { p.streak = 0; }

                // çµæœã¯æ•™å“¡ãŒç”»é¢ã‚’é€²ã‚ã‚‹ã¾ã§é€ä¿¡ã›ãšã€pã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ä¿æŒã—ã¦ãŠã
                p.lastResult = { isCorrect: isCorrect, points: points, bonus: bonus };

                checkAllAnswered();
            }
        }

        function broadcast(dataObj) {
            if (!peer) return;
            const msg = JSON.stringify(dataObj);
            Object.values(players).forEach(p => p.conn.send(msg));
        }

        function startGame() {
            document.getElementById('view-lobby').classList.add('hidden');
            currentQIndex = -1; nextQuestion();
        }

        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex >= activeQuiz.questions.length) { showFinalResult(); return; }

            const q = activeQuiz.questions[currentQIndex];
            document.getElementById('view-interim').classList.add('hidden');
            document.getElementById('view-question').classList.remove('hidden');
            document.getElementById('q-num').innerText = currentQIndex + 1;
            // å•é¡Œæ–‡ï¼ˆç¿»è¨³å¯¾å¿œï¼‰
            let qTextHtml = `<div>${q.text}</div>`;
            if (q.text_en || q.text_zh) {
                qTextHtml += `<div style="font-size:0.6em; margin-top:10px; font-weight:normal; color:#555;">`;
                if (q.text_en) qTextHtml += `<span style="margin-right:20px;">ğŸ‡ºğŸ‡¸ ${q.text_en}</span>`;
                if (q.text_zh) qTextHtml += `<span>ğŸ‡¨ğŸ‡³ ${q.text_zh}</span>`;
                qTextHtml += `</div>`;
            }
            document.getElementById('q-text').innerHTML = qTextHtml;

            const colors = ['bg-red', 'bg-blue', 'bg-yellow', 'bg-green'];
            const shapes = ['â–²', 'â—†', 'â—', 'â– '];
            document.getElementById('options-area').innerHTML = q.options.map((opt, i) => {
                let optHtml = `<div style="font-size:1em;">${opt || '(ãªã—)'}</div>`;
                if ((q.options_en && q.options_en[i]) || (q.options_zh && q.options_zh[i])) {
                    optHtml += `<div style="font-size:0.65em; margin-top:8px; font-weight:normal; line-height:1.2; opacity:0.9;">`;
                    if (q.options_en && q.options_en[i]) optHtml += `<div style="margin-bottom:2px;">ğŸ‡ºğŸ‡¸ ${q.options_en[i]}</div>`;
                    if (q.options_zh && q.options_zh[i]) optHtml += `<div>ğŸ‡¨ğŸ‡³ ${q.options_zh[i]}</div>`;
                    optHtml += `</div>`;
                }
                return `<div class="option-card ${colors[i]}" style="display:flex; align-items:center; text-align:left;">
                    <span class="shape-icon">${shapes[i]}</span>
                    <div style="flex:1;">${optHtml}</div>
                </div>`;
            }).join('');

            document.getElementById('q-timer').innerText = q.time;
            document.getElementById('pre-read-overlay').classList.remove('hidden');
            document.getElementById('options-area').classList.add('hidden'); // â† ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ä¸­ã¯é¸æŠè‚¢ã‚’éš ã™

            let preTime = 7;
            document.getElementById('pre-timer').innerText = preTime;

            Object.values(players).forEach(p => p.hasAnsweredThisRound = false);

            // äº‹å‰èª­ã¿è¾¼ã¿ç”¨ä¿¡å·ã‚’é€ä¿¡ (7ç§’å¾…ã¡)
            broadcast({
                type: "PRE_QUESTION",
                qNum: currentQIndex + 1,
                time: q.time,
                qText: q.text,
                qText_en: q.text_en,
                qText_zh: q.text_zh,
                qOptions: q.options,
                qOptions_en: q.options_en,
                qOptions_zh: q.options_zh,
                preTime: preTime
            });

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                preTime--;
                document.getElementById('pre-timer').innerText = preTime;

                if (preTime <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('pre-read-overlay').classList.add('hidden');
                    document.getElementById('options-area').classList.remove('hidden'); // â† é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼

                    // 7ç§’çµŒã£ãŸã‚‰æœ¬æ ¼çš„ã«è§£ç­”ã‚¹ã‚¿ãƒ¼ãƒˆ
                    broadcast({ type: "QUESTION_START" });

                    remainingTime = q.time;
                    document.getElementById('q-timer').innerText = remainingTime;
                    timerInterval = setInterval(() => {
                        remainingTime--;
                        document.getElementById('q-timer').innerText = remainingTime;
                        if (remainingTime <= 0) { clearInterval(timerInterval); finishQuestionPhase(); }
                    }, 1000);
                }
            }, 1000);
        }

        function checkAllAnswered() {
            if (Object.values(players).every(p => p.hasAnsweredThisRound)) {
                clearInterval(timerInterval); setTimeout(finishQuestionPhase, 1000);
            }
        }

        function finishQuestionPhase() {
            document.getElementById('view-question').classList.add('hidden');

            // æ­£è§£ç™ºè¡¨ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('view-reveal').classList.remove('hidden');

            const q = activeQuiz.questions[currentQIndex];
            const correctIndex = parseInt(q.correct);
            const colors = ['bg-red', 'bg-blue', 'bg-yellow', 'bg-green'];
            const shapes = ['â–²', 'â—†', 'â—', 'â– '];

            const revealBox = document.getElementById('reveal-correct-box');
            revealBox.className = colors[correctIndex];
            revealBox.innerHTML = `<span style="font-size:1.5em; margin-right:15px;">${shapes[correctIndex]}</span> ${q.options[correctIndex] || '(ãªã—)'}`;

            // ç”Ÿå¾’å´ã¸æ­£èª¤çµæœã®ã¿ã‚’ä¸€æ–‰é€ä¿¡
            Object.values(players).forEach(p => {
                if (!p.hasAnsweredThisRound) {
                    // æ™‚é–“åˆ‡ã‚Œæœªå›ç­”
                    p.streak = 0;
                    p.conn.send(JSON.stringify({ type: "RESULT", isCorrect: false, points: 0, bonus: 0 }));
                } else if (p.lastResult) {
                    // å›ç­”æ¸ˆã¿
                    p.conn.send(JSON.stringify({ type: "RESULT", isCorrect: p.lastResult.isCorrect, points: p.lastResult.points, bonus: p.lastResult.bonus }));
                }
            });
        }

        function showInterimRanking() {
            document.getElementById('view-reveal').classList.add('hidden');
            document.getElementById('view-interim').classList.remove('hidden');

            const sorted = Object.values(players).sort((a, b) => b.score - a.score);

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã«ãªã£ãŸã‚‰ã€ç”Ÿå¾’å´ã«ã‚‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹
            const top5Data = sorted.slice(0, 5).map(p => ({ name: p.name, score: p.score, streak: p.streak }));
            broadcast({ type: "RANKING", top5: top5Data });

            // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
            document.getElementById('interim-table').innerHTML = '<tr><th>é †ä½</th><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>é€£ç¶š<br>æ­£è§£</th></tr>' +
                sorted.slice(0, 5).map((p, i) => `<tr class="ranking-row" style="--i: ${i};"><td>${i + 1}</td><td>${p.name}</td><td>${p.score}</td><td>${p.streak >= 2 ? `ğŸ”¥x${p.streak}` : '-'}</td></tr>`).join('');
        }

        function showFinalResult() {
            clearInterval(timerInterval);
            document.getElementById('view-question').classList.add('hidden');
            document.getElementById('view-interim').classList.add('hidden');
            document.getElementById('view-result').classList.remove('hidden');

            const sorted = Object.values(players).sort((a, b) => b.score - a.score);

            // ç”Ÿå¾’å´ã«ã‚‚æœ€çµ‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é€ã‚‹
            const finalData = sorted.map((p, idx) => ({ rank: idx + 1, name: p.name, score: p.score }));
            broadcast({ type: "FINAL_RANKING", results: finalData });

            [1, 2, 3].forEach(i => {
                document.getElementById(`name-${i}`).innerText = '';
                document.getElementById(`score-${i}`).innerText = '';
                document.getElementById(`bar-${i}`).style.height = '0px';
            });

            if (sorted[0]) { document.getElementById('name-1').innerText = sorted[0].name; document.getElementById('score-1').innerText = sorted[0].score; setTimeout(() => document.getElementById('bar-1').style.height = "250px", 500); }
            if (sorted[1]) { document.getElementById('name-2').innerText = sorted[1].name; document.getElementById('score-2').innerText = sorted[1].score; setTimeout(() => document.getElementById('bar-2').style.height = "180px", 800); }
            if (sorted[2]) { document.getElementById('name-3').innerText = sorted[2].name; document.getElementById('score-3').innerText = sorted[2].score; setTimeout(() => document.getElementById('bar-3').style.height = "120px", 1100); }

            if (sorted.length > 3) {
                let tableHtml = ''; for (let i = 3; i < sorted.length; i++) tableHtml += `<tr><td>${i + 1}ä½</td><td>${sorted[i].name}</td><td>${sorted[i].score}</td></tr>`;
                document.getElementById('final-table').innerHTML = tableHtml;
            }
            broadcast({ type: "END" });
        }

        function downloadCSV() {
            const sorted = Object.values(players).sort((a, b) => b.score - a.score);
            if (sorted.length === 0) {
                alert("å‚åŠ è€…ãŒã„ãªã„ã‹ã€ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            // Excelã§æ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã«BOM (Byte Order Mark) ã‚’å…ˆé ­ã«è¿½åŠ 
            let csvContent = "\uFEFF";
            csvContent += "é †ä½,åå‰,ã‚¹ã‚³ã‚¢\n";

            sorted.forEach((p, index) => {
                let name = p.name ? p.name.replace(/"/g, '""') : 'ä¸æ˜';
                if (name.includes(',') || name.includes('\\n') || name.includes('"')) {
                    name = `"${name}"`;
                }
                csvContent += `${index + 1},${name},${p.score}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const s = document.getElementById('target-subject').value;
            const g = document.getElementById('target-grade').value;
            const r = document.getElementById('target-round').value;
            const title = activeQuiz ? activeQuiz.title : "ç„¡é¡Œ";
            const filename = `Babootæˆç¸¾_${s}_${g}å¹´_ç¬¬${r}å›_${title}.csv`;

            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.onload = initDashboard;
    </script>
</body>

</html>